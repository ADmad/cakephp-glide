# Cakephp Glide

CakePHP 3.x plugin to help using [Glide](http://glide.thephpleague.com/) image manipulation library.

The plugin consists of a CakePHP dispatch filter, view helper and a Glide response class.

## Installation

Install the plugin through composer

```
composer require admad/cakephp-glide
```

and from you app's root folder load using

```
./bin/cake plugin load -b
```

## Configuration

The plugin's bootstrap file writes few config values which you can override as
per your needs.

```php
Configure::write('Glide', [
    // Value of 'serverConfig' is passed as argument to Glide's ServerFactory::create() call.
    // http://glide.thephpleague.com/1.0/config/the-server/
    'serverConfig' => [
        // URL part to be omitted from source path
        // http://glide.thephpleague.com/1.0/config/base-url/
        'base_url' => '/images/',

        // Path or League\Flysystem adapter instance to read images from.
        // http://glide.thephpleague.com/1.0/config/source-and-cache/
        'source' => WWW_ROOT . 'uploads/',

        // Path or League\Flysystem adapter instance to write cached images to.
        'cache' => WWW_ROOT . 'cache',

        // Response class for serving images. You normally don't need to change this.
        // There's an official response class for CakePHP too but this one provides
        // more flexibility.
        // http://glide.thephpleague.com/1.0/config/responses/
        'response' => new ADmad\Glide\Responses\CakeResponseFactory(),
    ],

    // Use secure URLs to prevent URL parameter manipulation.
    // http://glide.thephpleague.com/1.0/config/secure-images/
    'secureUrls' => true,

    // Response headers to set.
    'headers' => [
        'Cache-Control' => 'max-age=31536000, public',
        'Expires' => true // Value `true` sets Expires to +1 year.
    ]
]);
```

## Usage

### Dispatcher

In your app's bootstrap setup the dispatch filter `GlideFilter` which intercepts
requests and serves images generated by Glide.

```php
DispatcherFactory::add('ADmad/Glide.Glide', ['for' => '/images']);
```

The above will make CakePHP run the dispatch filter for URLs staring with `/images`.

For the default config shown above, for URL like `domain.com/images/user/profile.jpg`
the source image should be under `webroot/uploads/user/profile.jpg`.

__Note__: Make sure the image URL does not directly map to image under webroot.
Otherwise as per Cake's default URL rewriting rules the image will be served by
webserver itself and request won't reach your Cake app.

### Helper

The provided `GlideHelper` helps creating URLs and image tags for generating
images. In can load the helper using `$this->loadHelper('ADmad/Glide.Glider')`
in your `AppView::initialize()` method. Here are the available methods:

```php
    /**
     * Creates a formatted IMG element.
     *
     * @param string $path Image path.
     * @param array $params Image manipulation parameters.
     * @param array $options Array of HTML attributes and options.
     *   See `$options` argument of `Cake\View\HtmlHelper::image()`.
     * @return string Complete <img> tag.
     */
    GlideHelper::image($path, array $params = [], array $options = [])

    /**
     * URL with query string based on resizing params.
     *
     * @param string $path Image path.
     * @param array $params Image manipulation parameters.
     * @return string Image URL.
     */
    GlideHelper::url($path, array $params = [])
```

The main benefit of using this helper is depending on the value of `secureUrls`
config, the generated URLs will contain a token which will be verified by the
dispatch filter.
